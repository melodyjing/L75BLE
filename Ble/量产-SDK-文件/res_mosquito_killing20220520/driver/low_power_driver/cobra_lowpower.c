#include "cobra_system.h"
#include "device1_scan.h"
#include "cobra4_common.h"
#include "rdw_dma.h"

#if (COBRA_POWER_DOWN_ENABLE)

#define BT_EMEM1_BACK			    ((volatile uint32_t  *)(0x2000bD00))
#define BT_EMEM11_BACK			  ((volatile uint32_t  *)(0x2000bD34))
#define BT_REG1_ADDR					((volatile uint32_t  *)(0x40100000))
#define BT_REG11_ADDR					((volatile uint32_t  *)(0x40100034))
#define BT_BACK1_LENG				  0x30			//==REG_BLECORE_COUNT
#define BT_BACK11_LENG				0x14C		//==REG_BLECORE_COUNT   0x1A4

extern volatile bool ble_deep_sleep;

void pop_ble_reg(void)
{
#if COBRA_UDMA_EN    
    
	  cobra_pcrm_udma_active_mode_clock_enable(1);
    
    app_rdw_udma_init();
    app_rdw_udma_get_channel(CHANNEL0, CH0_SOFTWARE);
    app_rdw_udma_get_channel(CHANNEL1, CH1_SOFTWARE);
    
    cobra_udma_channel_attribute_disable(CHANNEL0,
                                    UDMA_ATTR_ALTSELECT | UDMA_ATTR_USEBURST |
                                    UDMA_ATTR_HIGH_PRIORITY |
                                    UDMA_ATTR_REQMASK);
    cobra_udma_set_channel_control(CHANNEL0 | UDMA_PRI_SELECT,
                              UDMA_SIZE_32 | UDMA_SRC_INC_32 | UDMA_DST_INC_32 |
                              UDMA_ARB_4);
    cobra_udma_set_channel_transfer(CHANNEL0 | UDMA_PRI_SELECT,
                                   UDMA_MODE_AUTO,
                                   (void *)(BT_EMEM1_BACK),
                                   (void *)(BT_REG1_ADDR),
                                   12);
                                   
     cobra_udma_channel_attribute_disable(CHANNEL1,
                                    UDMA_ATTR_ALTSELECT | UDMA_ATTR_USEBURST |
                                    UDMA_ATTR_HIGH_PRIORITY |
                                    UDMA_ATTR_REQMASK);
    cobra_udma_set_channel_control(CHANNEL1 | UDMA_PRI_SELECT,
                              UDMA_SIZE_32 | UDMA_SRC_INC_32 | UDMA_DST_INC_32 |
                              UDMA_ARB_1);
    cobra_udma_set_channel_transfer(CHANNEL1 | UDMA_PRI_SELECT,
                                   UDMA_MODE_AUTO,
                                   (void *)(BT_EMEM11_BACK),
                                   (void *)(BT_REG11_ADDR),
                                   83);  
                                   
    cobra_udma_enable_channel(CHANNEL0);
    cobra_udma_enable_channel(CHANNEL1);                               
    cobra_udma_channel_request(CHANNEL0);
    cobra_udma_channel_request(CHANNEL1);    
#else
	memcpy((void*)BT_REG1_ADDR,(void*)BT_EMEM1_BACK,BT_BACK1_LENG);
	memcpy((void*)BT_REG11_ADDR,(void*)BT_EMEM11_BACK,BT_BACK11_LENG);															
#endif																	 
}   

void isdeep_sleep(void)
{
		ble_deep_sleep = false;
	
		if(ip_deepslcntl_deep_sleep_stat_getf())
		{
			  ble_deep_sleep = true;
//        cobra_m4_gpio_set_value(GPIO_PIN_27,0);
		}
		
}
 
 

#if 0
uint16_t const cobra_umcu_ppu_powerup[] = {	
#if (!HZ32000)  //standby1
0x6c02,
0x4000,
0x004c,
0x8003,
0x008c,
0x1c4c,
0x8001,
0x008c,
0x224c,
0x8000, //0x8003,//0x8000
0x008c,
0x240a,
0xac14,
0xc000,
0x81c4,	//0x81c4,	//0x81fc
0x4411,
0x400f,
0x4025,
0x004c,
0x801a,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x801e,
0x40e6,
0x004c,
0xb000,
0x008c,
0x080c,
0x4420,
0x401e,
0x004c,
0x140c,
0x4424,
0x4022,
0x401a,
0x0051,
0x008a,
0x782c,
0x00ca,
0x7834,
0x00ca,
0x782c,
0x004c,
0x8060,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x80be,
0x40e6,
0x004c,
0x803c,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x80be,
0x40e6,
0x004c,
0xc002,
0xb040,
0x008c,
0x080c,
0x4443,
0x4041,
0x0047,
0x008c,
0xcc00,
0x010c,
0xd000,
0x85a0,
0x008c,
0x140c,
0x444d,
0x404b,
0x004c,
0xc000,
0x8008,
0x008c,
0x060c,
0x0043,
0x008a,
0x00ca,
0x7858,
0x060c,
0x4052,
0x004c,
0x8060,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x80e7,
0x40e6,
0x004c,
0xc002,
0xb040,
0x008c,
0x080c,
0x4467,
0x4065,
0x0047,
0x008c,
0xcc00,
0x010c,
0xd000,
0x84e0,
0x008c,
0x140c,
0x4471,
0x406f,
0x004c,
0xc000,
0x8008,
0x008c,
0x060c,
0x0043,
0x008a,
0x00ca,
0x787c,
0x060c,
0x4076,
0x004c,
0x8084,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x810b,
0x40e6,
0x004c,
0xc002,
0xa000,
0x008c,
0x080c,
0x448b,
0x4089,
0x004e,
0x008a,
0x00ca,
0x00ca,
0x7894,
0x004c,
0xc480,
0x8301,
0x4097,
0x004c,
0xc480,
0x8300,
0x008c,
0x140c,
0x449b,
0x4099,
0x004c,
0x080c,
0x004e,
0x008a,
0x78a4,
0x00ca,
0x78a4,
0x00ca,
0x78a7,
0x004a,
0x008c,
0x080c,
0x004c,
0x8200,
0x008c,
0x060c,
0xa8e0,
0x8000,
0x000c,
0x44b0,
0x40ae,
0x0064,
0x008c,
0xc400,
0x010c,
0xc400,
0x0144,
0x00cc,
0x78be,
0x0043,
0x008a,
0x00ca,
0x78be,
0x060c,
0x40ab,
0x004c,
0x80c6,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x8145,
0x40e6,
0xac0c,
0xc000,
0x8002,
0x44cb,
0x40c9,
0xa504,
0xc000,
0x8122,
0x44d0,
0x40ce,
0x40e3,
0x004c,
0x801f,
0x008a,
0x00ca,
0x4cd7,
0x40d4,
0x40d8,
0xa504,
0xc000,
0x813f,
0x44dd,
0x40db,
0xac0c,
0xc000,
0x8000,
0x44e2,
0x40e0,
0x4012,
0x68d8,
0x6ad8,
0x40e3,
0x008c,
0x160c,
0x004c,
0xb000,
0x008c,
0x080c,
0x44ee,
0x40ec,
0x004c,
0x80c6,
0x008c,
0x140c,
0x004c,
0x004c,
0x004c,

#else				//HZ32000 = 1  standby2

//0x6c02,
//0x4000,
//0x004c,
//0x8003,
//0x008c,
//0x1c4c,
//0x8001,
//0x008c,
//0x224c,
//0x8000,		//0x8003,//0x8000
//0x008c,
//0x240a,
//0xac14,
//0xc000,
//0x81c4,	//0x81c4,		//0x81fc,
//0x4411,
//0x400f,
//0x4025,
//0x004c,
//0x801a,
//0x008c,
//0x1e0c,
//0x004c,
//0xc000,
//0x801e,
//0x40e6,
//0x004c,
//0xb000,
//0x008c,
//0x080c,
//0x4420,
//0x401e,
//0x004c,
//0x140c,
//0x4424,
//0x4022,
//0x401a,
//0x0051,
//0x008a,
//0x782c,
//0x00ca,
//0x7834,
//0x00ca,
//0x782c,
//0x004c,
//0x8060,
//0x008c,
//0x1e0c,
//0x004c,
//0xc000,
//0x80be,
//0x40e6,
//0x004c,
//0x803c,
//0x008c,
//0x1e0c,
//0x004c,
//0xc000,
//0x80be,
//0x40e6,
//0x004c,
//0xc002,
//0xb040,
//0x008c,
//0x080c,
//0x4443,
//0x4041,
//0x0047,
//0x008c,
//0xcc00,
//0x010c,
//0xd000,
//0x85a0,
//0x008c,
//0x140c,
//0x444d,
//0x404b,
//0x004c,
//0xc000,
//0x8008,
//0x008c,
//0x060c,
//0x0043,
//0x008a,
//0x00ca,
//0x7858,
//0x060c,
//0x4052,
//0x004c,
//0x8060,
//0x008c,
//0x1e0c,
//0x004c,
//0xc000,
//0x80e7,
//0x40e6,
//0x004c,
//0xc002,
//0xb040,
//0x008c,
//0x080c,
//0x4467,
//0x4065,
//0x0047,
//0x008c,
//0xcc00,
//0x010c,
//0xd000,
//0x84e0,
//0x008c,
//0x140c,
//0x4471,
//0x406f,
//0x004c,
//0xc000,
//0x8008,
//0x008c,
//0x060c,
//0x0043,
//0x008a,
//0x00ca,
//0x787c,
//0x060c,
//0x4076,
//0x004c,
//0x8084,
//0x008c,
//0x1e0c,
//0x004c,
//0xc000,
//0x810b,
//0x40e6,
//0x004c,
//0xc002,
//0xa000,
//0x008c,
//0x080c,
//0x448b,
//0x4089,
//0x004e,
//0x008a,
//0x00ca,
//0x00ca,
//0x7894,
//0x004c,
//0xc480,
//0x8301,
//0x4097,
//0x004c,
//0xc480,
//0x8300,
//0x008c,
//0x140c,
//0x449b,
//0x4099,
//0x004c,
//0x080c,
//0x004e,
//0x008a,
//0x78a4,
//0x00ca,
//0x78a4,
//0x00ca,
//0x78a7,
//0x004a,
//0x008c,
//0x080c,
//0x004c,
//0x8200,
//0x008c,
//0x060c,
//0xa8e0,
//0x8000,
//0x000c,
//0x44b0,
//0x40ae,
//0x0064,
//0x008c,
//0xc400,
//0x010c,
//0xc400,
//0x0144,
//0x00cc,
//0x78be,
//0x0043,
//0x008a,
//0x00ca,
//0x78be,
//0x060c,
//0x40ab,
//0x004c,
//0x80c6,
//0x008c,
//0x1e0c,
//0x004c,
//0xc000,
//0x8145,
//0x40e6,
//0xac0c,
//0xc000,
//0x8002,
//0x44cb,
//0x40c9,
//0xa504,
//0xc000,
//0x8028,
//0x44d0,
//0x40ce,
//0x40e3,
//0x004c,
//0x801f,
//0x008a,
//0x00ca,
//0x4cd7,
//0x40d4,
//0x40d8,
//0xa504,
//0xc000,
//0x803f,
//0x44dd,
//0x40db,
//0xac0c,
//0xc000,
//0x8000,
//0x44e2,
//0x40e0,
//0x4012,
//0x68d8,
//0x6ad8,
//0x40e3,
//0x008c,
//0x160c,
//0x004c,
//0xb000,
//0x008c,
//0x080c,
//0x44ee,
//0x40ec,
//0x004c,
//0x80c6,
//0x008c,
//0x140c,
//0x004c,
//0x004c,
//0x004c,
0x6c02,
0x4000,
0x004c,
0x8003,
0x008c,
0x1c4c,
0x8001,
0x008c,
0x224c,
0x8000,
0x008c,
0x240a,
0xac14,
0xc000,
0x81f4,
0x4411,
0x400f,
0x4025,
0x004c,
0x801a,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x801e,
0x40e7,
0x004c,
0xb000,
0x008c,
0x080c,
0x4420,
0x401e,
0x004c,
0x140c,
0x4424,
0x4022,
0x401a,
0x0051,
0x008a,
0x782c,
0x00ca,
0x7834,
0x00ca,
0x782c,
0x004c,
0x8060,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x80be,
0x40e7,
0x004c,
0x803c,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x80be,
0x40e7,
0x004c,
0xc002,
0xb040,
0x008c,
0x080c,
0x4443,
0x4041,
0x0047,
0x008c,
0xcc00,
0x010c,
0xd000,
0x85a0,
0x008c,
0x140c,
0x444d,
0x404b,
0x004c,
0xc000,
0x8008,
0x008c,
0x060c,
0x0043,
0x008a,
0x00ca,
0x7858,
0x060c,
0x4052,
0x004c,
0x8060,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x80e7,
0x40e7,
0x004c,
0xc002,
0xb040,
0x008c,
0x080c,
0x4467,
0x4065,
0x0047,
0x008c,
0xcc00,
0x010c,
0xd000,
0x84e0,
0x008c,
0x140c,
0x4471,
0x406f,
0x004c,
0xc000,
0x8008,
0x008c,
0x060c,
0x0043,
0x008a,
0x00ca,
0x787c,
0x060c,
0x4076,
0x004c,
0x8084,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x810b,
0x40e7,
0x004c,
0xc002,
0xa000,
0x008c,
0x080c,
0x448b,
0x4089,
0x004e,
0x008a,
0x00ca,
0x00ca,
0x7894,
0x004c,
0xc480,
0x8301,
0x4097,
0x004c,
0xc480,
0x8300,
0x008c,
0x140c,
0x449b,
0x4099,
0x004c,
0x080c,
0x004e,
0x008a,
0x78a4,
0x00ca,
0x78a4,
0x00ca,
0x78a7,
0x004a,
0x008c,
0x080c,
0x004c,
0x8200,
0x008c,
0x060c,
0xa8e0,
0x8000,
0x000c,
0x44b0,
0x40ae,
0x0064,
0x008c,
0xc400,
0x010c,
0xc400,
0x0144,
0x00cc,
0x78be,
0x0043,
0x008a,
0x00ca,
0x78be,
0x060c,
0x40ab,
0x004c,
0x80c6,
0x008c,
0x1e0c,
0x004c,
0xc000,
0x8145,
0x40e7,
0xac0c,
0xc000,
0x8002,
0x44cb,
0x40c9,
0xa504,
0xc000,
0x8028,
0x44d0,
0x40ce,
0x40e3,
0x004c,
0x801f,
0x008a,
0x00ca,
0x4cd7,
0x40d4,
0x40d8,
0xa504,
0xc000,
0x803f,
0x44dd,
0x40db,
0xac0c,
0xc000,
0x8000,
0x44e2,
0x40e0,
0x4012,
0x68d8,
0x6ad8,
0x7ad8,
0x40e3,
0x008c,
0x160c,
0x004c,
0xb000,
0x008c,
0x080c,
0x44ef,
0x40ed,
0x004c,
0x80c6,
0x008c,
0x140c,
0x004c,
0x004c,
0x004c,

#endif
};
extern volatile COBRA_PINMUX_TypeDef *cobra_pinmux;
extern void init_wake_up(void);
void p_ppu_power(void)
{
//#if (MCU_POWER_DOWN)
//			app_cobra_umcu_clk_enable(1);
//			app_cobra4_umcu_enable_sram();

//			cobra_umcu_clear_intr_wevent();    //???
//		  cobra_umcu_clear_intr_done();
//			cobra_umcu_copy_program((uint16_t *)cobra_umcu_ppu_powerup, sizeof(cobra_umcu_ppu_powerup)/sizeof(uint16_t));

//#if (LOW_POWER_WAKE_UP_BY_GPIO)
//			init_wake_up();
//#elif LOW_POWER_WAKE_UP_BY_UART
//      init_wake_up();	
//#else			
//			NVIC_DisableIRQ((IRQn_Type)PAD_TRIGGER_SINGLE_IRQ);			
//#endif	
//			cobra_pinmux->PIN0_MUX = PIN_MODE_3;
//			cobra_pinmux->PIN1_MUX = PIN_MODE_1;
//			cobra_pinmux->PIN2_MUX = PIN_MODE_3;
//#ifndef  SPI_FLASH_RUN	
//			cobra_pinmux->PIN3_MUX = PIN_MODE_3;
//			cobra_pinmux->PIN4_MUX = PIN_MODE_0;
////			cobra_pinmux->PIN5_MUX = PIN_MODE_0;
//#endif	
//			cobra_pinmux->PIN6_MUX = PIN_MODE_2;
//			cobra_pinmux->PIN7_MUX = PIN_MODE_3;
//			cobra_pinmux->PIN8_MUX = PIN_MODE_3;
//			//cobra_pinmux->PIN9_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN10_MUX = PIN_MODE_0;
//			//cobra_pinmux->PIN11_MUX = PIN_MODE_0;
//			//cobra_pinmux->PIN12_MUX = PIN_MODE_0;
//#ifndef  SPI_FLASH_RUN			
//			cobra_pinmux->PIN13_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN14_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN15_MUX = PIN_MODE_1;
//#endif			
//			cobra_pinmux->PIN16_MUX = PIN_MODE_6;
//			cobra_pinmux->PIN17_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN18_MUX = PIN_MODE_2;
//			cobra_pinmux->PIN19_MUX = PIN_MODE_6;
//			cobra_pinmux->PIN20_MUX = PIN_MODE_3;
//			cobra_pinmux->PIN21_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN22_MUX = PIN_MODE_6;
//			cobra_pinmux->PIN23_MUX = PIN_MODE_6;
//			cobra_pinmux->PIN24_MUX = PIN_MODE_2;
//			cobra_pinmux->PIN25_MUX = PIN_MODE_2;
//			cobra_pinmux->PIN26_MUX = PIN_MODE_3;
//			cobra_pinmux->PIN27_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN28_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN29_MUX = PIN_MODE_0;
//			cobra_pinmux->PIN30_MUX = PIN_MODE_1;
//			cobra_pinmux->PIN31_MUX = PIN_MODE_1;

///*
//			Power off Active/Idle/Standby???Shutdown?:
//			??trigger??
//			pwr_en=0 //0x400890d8, 8’h36 : pwr_en ? pwdata [0] ;

//*/

////			DPIN_PWR_EN	=	0;
//			cobra_m4_power_off_enable(0);       //?????????   
////			cobra4_aon_wk_protection_en(1);
//			
//			
////			app_drive_test_retention_write();

//			
////			app_cobra_umcu_run();
//			
//			
////			app_drive_test_retention_sleep();
////			app_drive_test_retention_read();
//#endif				
}

extern volatile bool ble_deep_sleep;
//void cobra_application_is_ok(void)
//{
//   	uint32_t *p_buffer= (uint32_t *)(OTA_APP_RUN_ADDRESS+4);
////	  app_length = *(uint32_t *)(OTA_FLASH_SIZE - FLASH_PAGE_SIZE);
////	  app_checksum = *(uint32_t *)(OTA_FLASH_SIZE - FLASH_PAGE_SIZE + 4);
////		if(app_length >= (OTA_APP_SIZE - 2*FLASH_PAGE_SIZE))  //No app
////			return;
////		if(ble_deep_sleep && ((cobra4_aon_app_ota_flag_read()>>24)==1))
//			if(ble_deep_sleep)
//				platform_app_init();
////		if((cobra4_aon_app_ota_flag_read()>>24)==2)
////			return;
//#if BLE_MESH	
//		if((*p_buffer & 0xffff0000)!=0x00840000)
//			return;
//#else
//		if((*p_buffer & 0xffff0000)!=0x00830000)
//			return;
//#endif	
// 		
////		cobra_pin_pullup_enable(PIN27_INDEX, 1);
////		app_m3_gpio_set_direction(GPIO_PIN_27, GPIO_INPUT);
////		if(app_m3_gpio_read_pin(GPIO_PIN_27) == 0)
////		{
////			 return;
////		}
//        
////		for(i = 0; i < app_length; i++)
////		{
////			 checksum += *p_buffer++;
////		}
////		
////		if(checksum == app_checksum)
//		{
//				platform_app_init();
//		}
//	
//}

#endif
#endif

bool isuartdata(void)
{
   if(!((cobra_uart_get_interrupt_statue(M3_UART0)& 0x0008)==0x0008)||!((cobra_uart_get_interrupt_statue(M3_UART0)& 0x0001)==0x0001))
		 return true;
	 else
		 return false;
}